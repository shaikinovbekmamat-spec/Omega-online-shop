<!DOCTYPE html>
<html lang="ru"
      xmlns:th="http://www.thymeleaf.org"
      xmlns:sec="http://www.thymeleaf.org/extras/spring-security">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title th:text="${product.name} + ' - OMEGA'">–¢–æ–≤–∞—Ä - OMEGA</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css"
          rel="stylesheet">
    <style>
        body { padding-top: 70px; }
        .product-image {
            max-width: 100%;
            height: auto;
            border-radius: 10px;
        }
        .price {
            font-size: 2.5rem;
            color: #28a745;
            font-weight: bold;
        }
        .specifications {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
        }
    </style>
</head>
<body>
<!-- Navbar -->
<nav class="navbar navbar-expand-lg navbar-dark bg-dark fixed-top">
    <div class="container">
        <a class="navbar-brand" th:href="@{/}"><strong>OMEGA</strong></a>
        <div class="collapse navbar-collapse">
            <ul class="navbar-nav ms-auto">
                <li class="nav-item"><a class="nav-link" th:href="@{/}">–ì–ª–∞–≤–Ω–∞—è</a></li>
                <li class="nav-item"><a class="nav-link" th:href="@{/catalog}">–ö–∞—Ç–∞–ª–æ–≥</a></li>
                <li class="nav-item"><a class="nav-link" th:href="@{/cart}">–ö–æ—Ä–∑–∏–Ω–∞</a></li>
                <li class="nav-item" sec:authorize="!isAuthenticated()">
                    <a class="nav-link" th:href="@{/login}">–í—Ö–æ–¥</a>
                </li>
                <li class="nav-item dropdown" sec:authorize="isAuthenticated()">
                    <a class="nav-link dropdown-toggle" href="#" role="button"
                       data-bs-toggle="dropdown">
                        <span sec:authentication="name">–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å</span>
                    </a>
                    <ul class="dropdown-menu dropdown-menu-end">
                        <li><a class="dropdown-item" th:href="@{/orders}">–ú–æ–∏ –∑–∞–∫–∞–∑—ã</a></li>
                        <li sec:authorize="hasRole('ADMIN')"><hr class="dropdown-divider"></li>
                        <li sec:authorize="hasRole('ADMIN')">
                            <a class="dropdown-item" th:href="@{/admin}">–ê–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å</a>
                        </li>
                        <li><hr class="dropdown-divider"></li>
                        <li>
                            <form th:action="@{/logout}" method="post" class="px-3 py-2">
                                <button type="submit" class="btn btn-danger btn-sm w-100">–í—ã—Ö–æ–¥</button>
                            </form>
                        </li>
                    </ul>
                </li>
            </ul>
        </div>
    </div>
</nav>

<div class="container my-5">
    <!-- –•–ª–µ–±–Ω—ã–µ –∫—Ä–æ—à–∫–∏ -->
    <nav aria-label="breadcrumb">
        <ol class="breadcrumb">
            <li class="breadcrumb-item"><a th:href="@{/}">–ì–ª–∞–≤–Ω–∞—è</a></li>
            <li class="breadcrumb-item"><a th:href="@{/catalog}">–ö–∞—Ç–∞–ª–æ–≥</a></li>
            <li class="breadcrumb-item">
                <a th:href="@{/catalog(categoryId=${product.category.id})}"
                   th:text="${product.category.name}">–ö–∞—Ç–µ–≥–æ—Ä–∏—è</a>
            </li>
            <li class="breadcrumb-item active" th:text="${product.name}">–¢–æ–≤–∞—Ä</li>
        </ol>
    </nav>

    <div class="row">
        <!-- –ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ —Ç–æ–≤–∞—Ä–∞ -->
        <div class="col-md-6">
            <img th:if="${product.imagePath != null}"
                 th:src="@{/uploads/{path}(path=${product.imagePath})}"
                 class="product-image"
                 th:alt="${product.name}">
            <img th:unless="${product.imagePath != null}"
                 src="https://via.placeholder.com/500x500?text=No+Image"
                 class="product-image"
                 alt="–ù–µ—Ç –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è">
        </div>

        <!-- –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ —Ç–æ–≤–∞—Ä–µ -->
        <div class="col-md-6">
            <h1 th:text="${product.name}">–ù–∞–∑–≤–∞–Ω–∏–µ —Ç–æ–≤–∞—Ä–∞</h1>

            <p class="text-muted">
                –ö–∞—Ç–µ–≥–æ—Ä–∏—è: <strong th:text="${product.category.name}">–ö–∞—Ç–µ–≥–æ—Ä–∏—è</strong>
            </p>

            <hr>

            <!-- –¶–µ–Ω–∞ -->
            <div class="mb-4">
                    <span class="price"
                          th:text="${#numbers.formatDecimal(product.price, 0, 'WHITESPACE', 2, 'POINT')} + ' —Å–æ–º'">
                        0.00 —Å–æ–º
                    </span>
            </div>

            <!-- –ù–∞–ª–∏—á–∏–µ -->
            <div class="mb-4">
                    <span th:if="${product.inStock}" class="badge bg-success fs-6">
                        ‚úì –í –Ω–∞–ª–∏—á–∏–∏ (–æ—Å—Ç–∞–ª–æ—Å—å: [[${product.quantity}]] —à—Ç.)
                    </span>
                <span th:unless="${product.inStock}" class="badge bg-danger fs-6">
                        ‚úó –ù–µ—Ç –≤ –Ω–∞–ª–∏—á–∏–∏
                    </span>
            </div>

            <!-- –û–ø–∏—Å–∞–Ω–∏–µ -->
            <div class="mb-4">
                <h5>–û–ø–∏—Å–∞–Ω–∏–µ</h5>
                <p th:text="${product.description}">–û–ø–∏—Å–∞–Ω–∏–µ —Ç–æ–≤–∞—Ä–∞</p>
            </div>

            <!-- –ö–Ω–æ–ø–∫–∞ –¥–æ–±–∞–≤–∏—Ç—å –≤ –∫–æ—Ä–∑–∏–Ω—É -->
            <div class="d-grid gap-2 mb-3">
                <form th:action="@{/cart/add}" method="post" id="addToCartForm">
                    <input type="hidden" name="productId" th:value="${product.id}">
                    <div class="input-group mb-3">
                        <button type="button" class="btn btn-outline-secondary"
                                onclick="changeQuantity(-1)">-</button>
                        <input type="number" name="quantity" id="quantity"
                               value="1" min="1" th:max="${product.quantity}"
                               class="form-control text-center">
                        <button type="button" class="btn btn-outline-secondary"
                                onclick="changeQuantity(1)">+</button>
                    </div>
                    <button type="submit" class="btn btn-primary btn-lg w-100"
                            th:disabled="${!product.inStock}">
                        <span th:if="${product.inStock}">üõí –î–æ–±–∞–≤–∏—Ç—å –≤ –∫–æ—Ä–∑–∏–Ω—É</span>
                        <span th:unless="${product.inStock}">–ù–µ—Ç –≤ –Ω–∞–ª–∏—á–∏–∏</span>
                    </button>
                </form>
            </div>

            <a th:href="@{/catalog}" class="btn btn-outline-secondary">
                ‚Üê –í–µ—Ä–Ω—É—Ç—å—Å—è –≤ –∫–∞—Ç–∞–ª–æ–≥
            </a>
        </div>
    </div>

    <!-- –•–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫–∏ -->
    <div class="row mt-5" th:if="${product.specifications != null}">
        <div class="col-12">
            <h3>–•–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫–∏</h3>
            <div class="specifications">
                    <pre th:text="${product.specifications}" style="white-space: pre-wrap;">
                        –•–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫–∏ —Ç–æ–≤–∞—Ä–∞
                    </pre>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
<script>
    // –ò–∑–º–µ–Ω–µ–Ω–∏–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞
    function changeQuantity(change) {
        const input = document.getElementById('quantity');
        const newValue = parseInt(input.value) + change;
        const max = parseInt(input.max);

        if (newValue >= 1 && newValue <= max) {
            input.value = newValue;
        }
    }

    // AJAX –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ –≤ –∫–æ—Ä–∑–∏–Ω—É
    document.getElementById('addToCartForm').addEventListener('submit', function(e) {
        e.preventDefault();

        const formData = new FormData(this);

        fetch('/cart/add', {
            method: 'POST',
            body: formData
        })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert('‚úÖ ' + data.message);
                    // –û–±–Ω–æ–≤–∏—Ç—å —Å—á—ë—Ç—á–∏–∫ –∫–æ—Ä–∑–∏–Ω—ã –µ—Å–ª–∏ –µ—Å—Ç—å
                    const badge = document.querySelector('.badge.bg-danger');
                    if (badge) {
                        badge.textContent = data.cartItemsCount;
                    }
                } else {
                    alert('‚ùå ' + data.message);
                }
            })
            .catch(error => {
                console.error('–û—à–∏–±–∫–∞:', error);
                alert('–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏–∏ —Ç–æ–≤–∞—Ä–∞');
            });
    });
</script>
</body>
</html>