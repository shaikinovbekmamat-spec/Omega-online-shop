<!DOCTYPE html>
<html lang="ru"
      xmlns:th="http://www.thymeleaf.org"
      xmlns:sec="http://www.thymeleaf.org/extras/spring-security">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ö–æ—Ä–∑–∏–Ω–∞ - OMEGA</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css"
          rel="stylesheet">
    <style>
        body { padding-top: 70px; }
        .cart-item {
            border-bottom: 1px solid #dee2e6;
            padding: 20px 0;
        }
        .cart-item:last-child { border-bottom: none; }
        .item-image {
            width: 100px;
            height: 100px;
            object-fit: cover;
            border-radius: 5px;
        }
        .total-section {
            background: #f8f9fa;
            padding: 30px;
            border-radius: 10px;
        }
    </style>
</head>
<body>
<!-- Navbar -->
<nav class="navbar navbar-expand-lg navbar-dark bg-dark fixed-top">
    <div class="container">
        <a class="navbar-brand" th:href="@{/}"><strong>OMEGA</strong></a>
        <div class="collapse navbar-collapse">
            <ul class="navbar-nav ms-auto">
                <li class="nav-item"><a class="nav-link" th:href="@{/}">–ì–ª–∞–≤–Ω–∞—è</a></li>
                <li class="nav-item"><a class="nav-link" th:href="@{/catalog}">–ö–∞—Ç–∞–ª–æ–≥</a></li>
                <li class="nav-item">
                    <a class="nav-link active" th:href="@{/cart}">
                        –ö–æ—Ä–∑–∏–Ω–∞ <span class="badge bg-danger" id="cart-count">[[${cart.totalItems}]]</span>
                    </a>
                </li>
                <li class="nav-item" sec:authorize="!isAuthenticated()">
                    <a class="nav-link" th:href="@{/login}">–í—Ö–æ–¥</a>
                </li>
                <li class="nav-item dropdown" sec:authorize="isAuthenticated()">
                    <a class="nav-link dropdown-toggle" href="#" role="button"
                       data-bs-toggle="dropdown">
                        <span sec:authentication="name">–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å</span>
                    </a>
                    <ul class="dropdown-menu dropdown-menu-end">
                        <li><a class="dropdown-item" th:href="@{/orders}">–ú–æ–∏ –∑–∞–∫–∞–∑—ã</a></li>
                        <li sec:authorize="hasRole('ADMIN')"><hr class="dropdown-divider"></li>
                        <li sec:authorize="hasRole('ADMIN')">
                            <a class="dropdown-item" th:href="@{/admin}">–ê–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å</a>
                        </li>
                        <li><hr class="dropdown-divider"></li>
                        <li>
                            <form th:action="@{/logout}" method="post" class="px-3 py-2">
                                <button type="submit" class="btn btn-danger btn-sm w-100">–í—ã—Ö–æ–¥</button>
                            </form>
                        </li>
                    </ul>
                </li>
            </ul>
        </div>
    </div>
</nav>

<div class="container my-5">
    <h1 class="mb-4">üõí –ö–æ—Ä–∑–∏–Ω–∞</h1>

    <!-- –°–æ–æ–±—â–µ–Ω–∏—è -->
    <div th:if="${successMessage}" class="alert alert-success alert-dismissible fade show">
        <span th:text="${successMessage}"></span>
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    </div>
    <div th:if="${errorMessage}" class="alert alert-danger alert-dismissible fade show">
        <span th:text="${errorMessage}"></span>
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    </div>

    <!-- –ü—É—Å—Ç–∞—è –∫–æ—Ä–∑–∏–Ω–∞ -->
    <div th:if="${cart.empty}" class="text-center py-5">
        <h3 class="text-muted mb-4">–í–∞—à–∞ –∫–æ—Ä–∑–∏–Ω–∞ –ø—É—Å—Ç–∞</h3>
        <a th:href="@{/catalog}" class="btn btn-primary btn-lg">
            –ü–µ—Ä–µ–π—Ç–∏ –≤ –∫–∞—Ç–∞–ª–æ–≥
        </a>
    </div>

    <!-- –¢–æ–≤–∞—Ä—ã –≤ –∫–æ—Ä–∑–∏–Ω–µ -->
    <div th:unless="${cart.empty}">
        <div class="row">
            <div class="col-lg-8">
                <!-- –°–ø–∏—Å–æ–∫ —Ç–æ–≤–∞—Ä–æ–≤ -->
                <div th:each="item : ${cart.items}" class="cart-item">
                    <div class="row align-items-center">
                        <!-- –ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ -->
                        <div class="col-md-2">
                            <img th:if="${item.imagePath != null}"
                                 th:src="@{/uploads/{path}(path=${item.imagePath})}"
                                 class="item-image"
                                 th:alt="${item.productName}">
                            <img th:unless="${item.imagePath != null}"
                                 src="https://via.placeholder.com/100"
                                 class="item-image" alt="No image">
                        </div>

                        <!-- –ù–∞–∑–≤–∞–Ω–∏–µ –∏ —Ü–µ–Ω–∞ -->
                        <div class="col-md-4">
                            <h5 th:text="${item.productName}">–¢–æ–≤–∞—Ä</h5>
                            <p class="text-muted mb-0">
                                –¶–µ–Ω–∞: <strong th:text="${#numbers.formatDecimal(item.price, 0, 'WHITESPACE', 2, 'POINT')} + ' —Å–æ–º'">0 —Å–æ–º</strong>
                            </p>
                        </div>

                        <!-- –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ -->
                        <div class="col-md-3">
                            <form th:action="@{/cart/update}" method="post" class="d-flex align-items-center">
                                <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}">
                                <input type="hidden" name="productId" th:value="${item.productId}">
                                <button type="button" class="btn btn-sm btn-outline-secondary"
                                        onclick="updateQuantity(this, -1)">-</button>
                                <input type="number" name="quantity"
                                       th:value="${item.quantity}"
                                       min="1" max="99"
                                       class="form-control mx-2 text-center"
                                       style="width: 70px;"
                                       onchange="this.form.submit()">
                                <button type="button" class="btn btn-sm btn-outline-secondary"
                                        onclick="updateQuantity(this, 1)">+</button>
                            </form>
                        </div>

                        <!-- –°—É–º–º–∞ -->
                        <div class="col-md-2 text-end">
                            <h5 th:text="${#numbers.formatDecimal(item.totalPrice, 0, 'WHITESPACE', 2, 'POINT')} + ' —Å–æ–º'">0 —Å–æ–º</h5>
                        </div>

                        <!-- –£–¥–∞–ª–∏—Ç—å -->
                        <div class="col-md-1">
                            <form th:action="@{/cart/remove}" method="post">
                                <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}">
                                <input type="hidden" name="productId" th:value="${item.productId}">
                                <button type="submit" class="btn btn-sm btn-outline-danger"
                                        onclick="return confirm('–£–¥–∞–ª–∏—Ç—å —Ç–æ–≤–∞—Ä –∏–∑ –∫–æ—Ä–∑–∏–Ω—ã?')">
                                    ‚úï
                                </button>
                            </form>
                        </div>
                    </div>
                </div>

                <!-- –û—á–∏—Å—Ç–∏—Ç—å –∫–æ—Ä–∑–∏–Ω—É -->
                <div class="mt-3">
                    <form th:action="@{/cart/clear}" method="post" style="display: inline;">
                        <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}">
                        <button type="submit" class="btn btn-outline-secondary"
                                onclick="return confirm('–û—á–∏—Å—Ç–∏—Ç—å –≤—Å—é –∫–æ—Ä–∑–∏–Ω—É?')">
                            üóëÔ∏è –û—á–∏—Å—Ç–∏—Ç—å –∫–æ—Ä–∑–∏–Ω—É
                        </button>
                    </form>
                </div>
            </div>

            <!-- –ò—Ç–æ–≥–æ–≤–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è -->
            <div class="col-lg-4">
                <div class="total-section sticky-top" style="top: 90px;">
                    <h4 class="mb-4">–ò—Ç–æ–≥–æ</h4>

                    <div class="d-flex justify-content-between mb-2">
                        <span>–¢–æ–≤–∞—Ä–æ–≤:</span>
                        <strong>[[${cart.totalItems}]] —à—Ç.</strong>
                    </div>

                    <hr>

                    <div class="d-flex justify-content-between mb-4">
                        <h5>–°—É–º–º–∞:</h5>
                        <h5 class="text-success" id="total-price">
                            [[${#numbers.formatDecimal(cart.totalPrice, 0, 'WHITESPACE', 2, 'POINT')}]] —Å–æ–º
                        </h5>
                    </div>

                    <!-- –ö–Ω–æ–ø–∫–∞ –æ—Ñ–æ—Ä–º–ª–µ–Ω–∏—è -->
                    <div class="d-grid gap-2">
                        <a th:href="@{/checkout}" class="btn btn-success btn-lg">
                            –û—Ñ–æ—Ä–º–∏—Ç—å –∑–∞–∫–∞–∑
                        </a>
                        <a th:href="@{/catalog}" class="btn btn-outline-secondary">
                            –ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å –ø–æ–∫—É–ø–∫–∏
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
<script>
    // –ò–∑–º–µ–Ω–µ–Ω–∏–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ –∫–Ω–æ–ø–∫–∞–º–∏ +/-
    function updateQuantity(button, change) {
        const form = button.closest('form');
        const input = form.querySelector('input[name="quantity"]');
        const newValue = parseInt(input.value) + change;

        if (newValue >= 1) {
            input.value = newValue;
            form.submit();
        }
    }
</script>
</body>
</html>