<!DOCTYPE html>
<html lang="ru" xmlns:th="http://www.thymeleaf.org">
<body>
    <!-- Фрагмент для отображения категории с подкатегориями -->
    <div th:fragment="category-item(category, productCounts, allCategories, level)" 
         class="category-item" th:style="'padding-left: ' + ${level * 30} + 'px;'">
        <div class="d-flex justify-content-between align-items-center p-2 border rounded mb-2 bg-light">
            <div class="flex-grow-1">
                <div class="d-flex align-items-center">
                    <i th:if="${category.parent != null}" class="bi bi-arrow-return-right me-2 text-muted"></i>
                    <strong th:text="${category.getFullPath()}">[[${category.name}]]</strong>
                    <span th:if="${category.parent != null}" class="badge bg-secondary ms-2">Подкатегория</span>
                </div>
                <div th:if="${category.description}" class="small text-muted mt-1">
                    [[${#strings.abbreviate(category.description, 50)}]]
                </div>
            </div>
            <div class="d-flex align-items-center gap-2">
                <span class="badge bg-info" th:text="${productCounts != null ? productCounts.get(category.id) : 0}">0</span>
                <small class="text-muted me-2" th:text="${#temporals.format(category.createdAt, 'dd.MM.yyyy')}">01.01.2024</small>
                <div class="btn-group btn-group-sm" role="group">
                    <a th:href="@{/admin/categories/new(parentId=${category.id})}"
                       class="btn btn-outline-success" title="Добавить подкатегорию">
                        <i class="bi bi-plus-circle"></i> Подкатегория
                    </a>
                    <a th:href="@{/admin/categories/{id}/edit(id=${category.id})}"
                       class="btn btn-outline-primary" title="Редактировать">
                        <i class="bi bi-pencil"></i>
                    </a>
                    <button type="button" class="btn btn-outline-danger"
                            data-bs-toggle="modal" th:data-bs-target="'#deleteModal' + ${category.id}" title="Удалить">
                        <i class="bi bi-trash"></i>
                    </button>
                </div>
            </div>
        </div>

        <!-- Модальное окно удаления -->
        <div class="modal fade" th:id="'deleteModal' + ${category.id}" tabindex="-1">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">Подтверждение удаления</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body">
                        <p>Вы действительно хотите удалить категорию <strong th:text="${category.getFullPath()}">?</strong></p>
                        <p class="text-danger" th:if="${productCounts != null && productCounts.get(category.id) > 0}">
                            <i class="bi bi-exclamation-triangle"></i>
                            В этой категории есть товары (<span th:text="${productCounts.get(category.id)}"></span>).
                        </p>
                        <p class="text-danger" th:if="${!category.children.isEmpty()}">
                            <i class="bi bi-exclamation-triangle"></i>
                            У этой категории есть подкатегории. Сначала удалите или переместите их.
                        </p>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Отмена</button>
                        <form th:action="@{/admin/categories/{id}/delete(id=${category.id})}" method="post" class="d-inline">
                            <button type="submit" class="btn btn-danger">Удалить</button>
                        </form>
                    </div>
                </div>
            </div>
        </div>

        <!-- Рекурсивно отображаем дочерние категории -->
        <div th:if="${!category.children.isEmpty()}" th:each="child : ${category.children}">
            <div th:replace="~{fragments/category-tree :: category-item(category=${child}, productCounts=${productCounts}, allCategories=${allCategories}, level=${level + 1})}"></div>
        </div>
    </div>
</body>
</html>


